# 13. 红黑树

二叉搜索树的各种操作时间复杂度为O(h)，但是树的高度h不可控，最差的情况为n。  
而**平衡搜索树**能将树的高度控制在O(lg(n))。  
常见的平衡搜索树有：  
* AVL树
* 红黑树
* treap （tree + heap，给每个元素随机的priority，从而间接的实现随机插入，使得树的期望高度为O(lg(n))）
* B树 （十八章介绍）
    * 2-3-4树

本章重点讨论红黑树，以及习题中出现的AVL树。AVL树较为简单所以先介绍AVL树。

## AVL树

AVL树由Adel’son-Vel’skii & Landis 在1962年发明，由他们的名字命名。  
比较一般的二叉搜索树，每个结点额外存储它的高度，nil的高度为0，其他节点的高度为**Height(x) = max(Height(x->left), Height(x->right)) + 1**。每个结点两个孩子的高度差不能超过1。  
当右子树的高度比左子树的高度高时，我们称right-heavy（如下图），反之这称left-heavy。

![AVL树](/.res/13_AVL.PNG)  

AVL树的各种查询操作都和普通二叉搜索树无异，所以我们只需关注会改变树结构的Insert操作和Delete操作。  
在一般的Insert或者Delete操作后，结点的高度会变，所以有可能会违反AVL树的性质，这时候我们需要引入一个操作Rotate（旋转）

## Rotate

旋转分为两种，左旋（LEFT-ROTATE）和右旋（RIGHT-ROTATE）。下图右测变为左侧的情况称为对x结点左旋，左侧变为右侧的情况称为对y结点做右旋。

![Rotate](/.res/13_2.PNG)  

我们可以发现旋转操作并不会影响二叉搜索树的性质。  
旋转前后都会保持*α <= x <= β <= y <= γ*  
下面是左旋的伪代码，右旋的操作和左旋对称，不再赘述。

![Rotate](/.res/13_LEFT_ROTATE.PNG)  

Ref：AVLTree::LeftRotate & AVLTree::RightRotate in [AVLTree.h](/Code/Thinkings/T-13-3-AVLTree/AVLTree.h)

## AVL树平衡调整（ADJUST_FROM(x)）

当Insert或者Delete一个元素后，平衡有可能被破坏，假设x是最底层被破坏性质的节点，而且是right-heavy时（left-heavy是对称的）：  
1. Balance
    * 如果x的右孩子y是平衡的或者right-heavy的（Figure 5）
        * 我们对x做LEFT-ROTATE操作可使其恢复平衡
        * 然后重新计算x和y的高度
    * 如果x的右孩子z是left-heavy的（Figure 6）
        * 我们先对z做RIGHT_ROTATE，然后对x做LEFT-ROTATE，可使其恢复平衡
        * 然后重新计算x，y，z的高度
2. Loop
    * 重新计算x的高度，并使得x=x->p继续循环，直到根节点
    * 若图中发现某节点不平衡的用*1. Balance*

![AVL树](/.res/13_AVL_ADJUST.PNG)  

Ref：AVLTree::AdjustFrom in [AVLTree.h](/Code/Thinkings/T-13-3-AVLTree/AVLTree.h)

## AVL树 Insert

因为插入的节点肯定是叶子节点，所以直接对插入节点调用ADJUST_FROM(x)即可。

Ref：AVLTree::Insert in [AVLTree.h](/Code/Thinkings/T-13-3-AVLTree/AVLTree.h)

## AVL树 Delete

删除操作略为复杂，可能会影响子节点的平衡。  
* 当被删除节点只有一个孩子，或者没有孩子时，被删除节点的孩子不会被应用
    * 这时对删除节点原来的父节点调用ADJUST_FROM(x)即可
* 当被删除节点有两个孩子时
    * 如果b被删除节点右子树的最小节点min的父节点或者爷节点为被删除节点，这时对min调用ADJUST_FROM(x)
    * 其他情况，对min原来的父节点调用ADJUST_FROM(x)

Ref：AVLTree::Delete in [AVLTree.h](/Code/Thinkings/T-13-3-AVLTree/AVLTree.h)


## 涉及数据结构
> 点击查看实现
+ **[AVL树](/Code/Thinkings/T-13-3-AVLTree/AVLTree.h)** 
+ **[红黑树](/Code/Algorithms/A-13-0-RedBlackTree/RedBlackTree.h)** 
